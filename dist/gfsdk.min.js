/*! GAMIFIVE SDK - v0.4 - 01-04-2015
* http://gamifive.com/
* Copyright (c) 2015 Gamifive; Licensed MIT */

var FBConnector=new function(){var a={appId:""};this.start=function(){var a,b=document,c="script",d="facebook-jssdk",e=b.getElementsByTagName(c)[0];b.getElementById(d)||(a=b.createElement(c),a.id=d,a.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(a,e))},this.login=function(a){var b=document.body.clientWidth>600?"popup":"touch";FB.login(function(b){b.authResponse?a.call(this,b):a.call(this,b)},{scope:"email,user_friends",display:b})},this.invite=function(a,b){FB.ui({method:"apprequests",message:a.message,data:JSON.stringify(a)},b)},this.setConfig=function(b,c){void 0!=a[b]&&(a[b]=c)},window.fbAsyncInit=function(){FB.init({appId:a.appId,cookie:!0,xfbml:!1,version:"v2.1"})}},Utils=new function(){this.dateNow=function(){return Date.now?Date.now():(new Date).getTime()},this.copyProperties=function(a,b){for(var c in a)b[c]=a[c];return b},this.getScriptParams=function(a){var b,c=document.querySelector(a),d={};return c&&(b=c.src.replace(/^[^\?]+\??/,""),d=this.dequerify(b)),d},this.cookie={get:function(a){var b=new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),c=document.cookie.replace(b,"$1");return decodeURIComponent(c)||null},set:function(a,b,c,d,e,f){if(!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a))return!1;var g="";if(c)switch(c.constructor){case Number:g=c===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+c;break;case String:g="; expires="+c;break;case Date:g="; expires="+c.toUTCString()}return document.cookie=encodeURIComponent(a)+"="+encodeURIComponent(b)+g+(e?"; domain="+e:"")+(d?"; path="+d:"")+(f?"; secure":""),!0},remove:function(a,b,c){return a&&this.has(a)?(document.cookie=encodeURIComponent(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; domain="+c:"")+(b?"; path="+b:""),!0):!1},has:function(a){var b="(?:^|;\\s*)"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=";return new RegExp(b).test(document.cookie)}},this.getAbsoluteUrl=function(){return window.location.origin},this.xhr=function(a,b,c){var d=new XMLHttpRequest;return d.onreadystatechange=function(){if(4===d.readyState){var a;try{a=d.response.replace(/(\n|\r)/gm,""),a=JSON.parse(a)}catch(b){}a.success=d.status>=200&&d.status<=399,c&&c(a,d)}},d.open(a,b),d.send(),d},this.querify=function(a){if(!a)return"";var b=new Array(Object.keys(a).length),c=0;for(var d in a)a.hasOwnProperty(d)&&(b[c++]=d+"="+a[d]);return"?"+b.join("&")},this.dequerify=function(a){var b=new Object;if(!a)return b;a=a.replace("?","");for(var c=a.split(/[;&]/),d=0;d<c.length;d++){var e=c[d].split("=");if(e&&2==e.length){var f=unescape(e[0]),g=unescape(e[1]);g=g.replace(/\+/g," "),b[f]=g}}return b};var a=!1;this.enableLog=function(b){a=!!b},this.log=function(){if(a){for(var b=new Array(arguments.length),c=0;c<arguments.length;c++)b[c]=arguments[c];console.log(b)}},this.debug=function(){for(var a=new Array(arguments.length),b=0;b<arguments.length;b++)a[b]=arguments[b];console.debug(a)},this.error=function(){for(var a=new Array(arguments.length),b=0;b<arguments.length;b++)a[b]=arguments[b];console.error(a)},this.hasClass=function(a,b){return(" "+document.getElementById(a).className+" ").indexOf(" "+b+" ")>-1},this.show=function(a){document.getElementById(a)&&GameOverUtils.hasClass(a,"hide")&&(document.getElementById(a).className=document.getElementById(a).className.replace(/\bhide\b/,""))},this.hide=function(a){document.getElementById(a)&&(GameOverUtils.hasClass(a,"hide")||(document.getElementById(a).className+=" hide"))}},GameOverCore=new function(){this.playAgain=function(){GamefiveSDK.startSession()},this.invite=function(){GamefiveSDK.invite();var a=GamefiveSDK.getConfig();this.trackEvent("Challenge","FbInvite",a.game.title+" + "+a.contentId)},this.g5challenge=function(a){GamefiveSDK.challenge(a)},this.otherGames=function(){return!0},this.connect=function(){GamefiveSDK.connect()},this.addListeners=function(){Utils.log("Gameover","addListeners"),GamefiveSDK.onEvent("user_no_credits",function(){Utils.show("paywall")}),GamefiveSDK.onEvent("user_credits_updated",function(b){if(Utils.hide("paywall"),a(b.title,b.message,b.success),"undefined"!=typeof b.credits){var c=parseInt(b.credits),d="",e=GamefiveSDK.getConfig();0==c&&"undefined"!=typeof e.dictionary.matchLeftNone?(d=e.dictionary.matchLeftNone.replace("%s",c),document.getElementById("credits-count").innerHTML=d):1==c&&"undefined"!=typeof e.dictionary.matchLeftSingular?(d=e.dictionary.matchLeftSingular.replace("%s",c),document.getElementById("credits-count").innerHTML=d):c>1&&"undefined"!=typeof e.dictionary.matchLeftPlural&&(d=e.dictionary.matchLeftPlural.replace("%s",c),document.getElementById("credits-count").innerHTML=d)}}),GamefiveSDK.onEvent("challenge_completed",function(b){b.success?(Utils.hide("challenge-ready-"+b.challenged_user_id),Utils.show("challenge-completed-"+b.challenged_user_id),Utils.hide("name-ready-"+b.challenged_user_id),Utils.show("name-completed-"+b.challenged_user_id)):a(b.title,b.message,!1)}),GamefiveSDK.onEvent("mip_connect_success",function(b){Utils.hide("fbconnect-calltoaction"),b&&"undefined"!=typeof b.title&&"undefined"!=typeof b.success_message&&a(b.title,b.success_message,!0),window.localStorage.getItem("_gameoverOpenFbModal_")&&localStorage.removeItem("_gameoverOpenFbModal_")}),GamefiveSDK.onEvent("mip_connect_error",function(b){Utils.hide("fbconnect-calltoaction"),b&&"undefined"!=typeof b.title&&"undefined"!=typeof b.error_message&&a(b.title,b.error_message,!1)}),GamefiveSDK.onEvent("fb_connect_show",function(){Utils.show("fbconnect-calltoaction")})},this.trackEvent=function(a,b,c,d){var e=GamefiveSDK.getConfig();e.debug?Utils.log("GameAnalytics","trackEvent",a,b,c,d):GameAnalytics.trackEvent(a,b,c,d)};var a=function(a,b,c){Utils.log("Gameover","showMessage",a,b,c),document.getElementById("message-title").innerHTML=a,document.getElementById("message-text").innerHTML=b,Utils.show("messages"),document.getElementById("messages").className+=c?" success":" error"}},GamefiveSDK=new function(){var a=new Object;this.reset=function(){a={}},this.init=function(b){Utils.copyProperties(b,a),Utils.enableLog(!!a.log);var d=function(){a.lite||(a.events=[],FBConnector.setConfig("appId",a.fbAppId),FBConnector.start(),GameOverCore.addListeners(),GamefiveSDK.controlFbConnected()),Utils.log("GamifiveSDK","init",a)};a.debug?Utils.xhr("GET",c("gamifiveinfo"),function(b){Utils.copyProperties(b,a),d()}):(Utils.copyProperties(window.GamifiveInfo,a),d())},this.onStartSession=function(b){Utils.log("GamifiveSDK","onStartSession",b),a.lite?Utils.error("GamifiveSDK","ERROR","in lite mode, onStartSession must not be used"):b&&"function"==typeof b?(a.startCallback=b,Utils.debug("GamifiveSDK","OK","callback function has been set correctly")):Utils.error("GamifiveSDK","ERROR","missing or illegal value for callback function")},this.startSession=function(){Utils.log("GamifiveSDK","startSession"),a.timestart=Utils.dateNow(),a.lite||Utils.xhr("GET",c("canDownload"),function(e,f){Utils.log("GamifiveSDK","startSession","canDownload",e,f),e.canDownload?(d["delete"](),a.startCallback&&a.startCallback.call()):Utils.xhr("GET",c("gameover"),function(a){d.create(a),b("user_no_credits")})}),a.contentId?Utils.debug("GamifiveSDK","OK","init has been called correctly"):Utils.error("GamifiveSDK","ERROR","init has not been called"),a.lite||(a.startCallback&&"function"==typeof a.startCallback?Utils.debug("GamifiveSDK","OK","onStartSession has been called correctly"):Utils.error("GamifiveSDK","ERROR","onStartSession has not been called")),GameOverCore.trackEvent("Play","GameStart",a.game.title+" + "+a.contentId,{valuable_cd:"Yes",action_cd:"Yes"})},this.endSession=function(b){if(Utils.log("GamifiveSDK","endSession",b),a.timeend=Utils.dateNow(),"number"==typeof b.score&&(a.score=parseFloat(b.score)),a.lite)Utils.xhr("GET",c("leaderboard",{start:a.timestart,duration:a.timeend-a.timestart,score:a.score,newapps:1,appId:a.contentId,label:a.label,userId:a.userId}));else{var e;e=a.challenge&&a.challenge.id?a.challenge.id:null,Utils.xhr("GET",c("gameover",{start:a.timestart,duration:a.timeend-a.timestart,score:a.score,challenge_id:e}),function(a){d.create(a)})}a.timestart&&"number"==typeof a.timestart?Utils.debug("GamifiveSDK","OK","startSession has been called correctly"):Utils.error("GamifiveSDK","ERROR","startSession has not been called"),"number"==typeof a.score?Utils.debug("GamifiveSDK","OK","score has been set correctly"):Utils.error("GamifiveSDK","ERROR","missing score value"),GameOverCore.trackEvent("Play","GameEnd",a.game.title+" + "+a.contentId,{valuable_cd:"No",action_cd:"No"})},this.getAvatar=function(){var b;return b=a.user&&a.user.avatar?a.user.avatar:null,Utils.log("GamifiveSDK","getAvatar",b),b},this.getNickname=function(){var b;return b=a.user&&a.user.nickname?a.user.nickname:null,Utils.log("GamifiveSDK","getNickname",b),b},this.controlFbConnected=function(){Utils.log("GamifiveSDK","controlFbConnected",!!window.localStorage.getItem("_gameoverOpenFbModal_"),!a.user.fbConnected),window.localStorage.getItem("_gameoverOpenFbModal_")&&!a.user.fbConnected&&b("fb_connect_show")},this.login=function(b,d){return Utils.log("GamifiveSDK","login",a.user.fbConnected),a.user.fbConnected?void b():a.fbExternal?void(document.location.href=a.fbExternal):void FBConnector.login(function(e){Utils.log("GamifiveSDK","login","FBConnector.login",e),"connected"==e.status&&Utils.xhr("GET",c("mipConnect",{access_token:e.authResponse.accessToken}),function(c,f){Utils.log("GamifiveSDK","login","mipConnect",c,f),200==parseInt(f.status)?(b(c),a.user.fbConnected=!0,e.authResponse&&e.authResponse.userID&&(a.user.fbUserId=e.authResponse.userID)):d&&d(c)})})},this.connect=function(){Utils.log("GamifiveSDK","connect"),this.login(function(a){b("mip_connect_success",a)},function(a){b("mip_connect_error",a)})},this.invite=function(){Utils.log("GamifiveSDK","invite"),this.login(function(){var d=a.dictionary.messageOfFbChallenge,e={score:a.score,contentId:a.contentId,userId:a.user.userId,message:d.replace("%s",a.score)};Utils.log("GamifiveSDK","invite","login",e),FBConnector.invite(e,function(d){Utils.log("GamifiveSDK","invite","FBConnector.invite",d),d&&d.to.length>0&&Utils.xhr("GET",c("updateCredits",{fbusers_id:d.to||null,userId:a.user.userId||null}),function(a){b("user_credits_updated",a)})})},function(a){b("mip_connect_error",a)})},this.challenge=function(d){Utils.log("GamifiveSDK","challenge",d),Utils.xhr("GET",c("newChallenge",{content_id:a.contentId,challenger_id:a.user.userId,challenged_id:d,challenger_score:a.score}),function(a){b("challenge_completed",a)})},this.onEvent=function(b,c){Utils.log("GamifiveSDK","onEvent",b,c),a.events[b]=c},this.getConfig=function(){return a};var b=function(b,c){Utils.log("GamifiveSDK","throwEvent",b,c),a.events[b]&&a.events[b](c)},c=function(b,c){var d=a.debug?"http://www2.giochissimo.it":Utils.getAbsoluteUrl(),e=a.debug?"/mock01/":"/v01/",f={canDownload:"user.candownload/"+a.contentId,gameover:"gameover/"+a.contentId,updateCredits:"mipuser.updatecredits",newChallenge:"challenge.post",mipConnect:"mipuser.fbconnect",leaderboard:"leaderboard",gamifiveinfo:"gamifiveinfo"},g=Utils.querify(c);return d+e+f[b]+g},d={create:function(a){if(!document.getElementById("gfsdk_root")){var b=document.createElement("div");b.id="gfsdk_root",document.body.appendChild(b);var c=function(a){a.stopPropagation()};b.addEventListener("touchmove",c),b.addEventListener("touchstart",c),b.addEventListener("touchend",c),b.innerHTML=a,Utils.log("GamifiveSDK","create","element",a,b)}},"delete":function(){if(document.getElementById("gfsdk_root")){var a=document.getElementById("gfsdk_root");document.body.removeChild(a),Utils.log("GamifiveSDK","delete",a)}}}},GamifiveSDK=GamefiveSDK;
//# sourceMappingURL=gfsdk.min.js.map