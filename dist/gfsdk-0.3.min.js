/*! GAMIFIVE SDK - v0.3 - 12-11-2014
* http://gamifive.com/
* Copyright (c) 2014 Gamifive; Licensed MIT */
!function(a){function b(a){if(!a)return"";var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return"?"+b.join("&")}function c(a){var b=new Object;if(!a)return b;for(var c=a.split(/[;&]/),d=0;d<c.length;d++){var e=c[d].split("=");if(e&&2==e.length){var f=unescape(e[0]),g=unescape(e[1]);g=g.replace(/\+/g," "),b[f]=g}}return b}function d(){var a,c={version:"0.3",contentId:""};Object.defineProperty(c,"dom",{get:function(){return a||(a=document.querySelector("#gfsdk_root")||d()),a},set:function(b){return!b&&a?(document.body.removeChild(a),a=null):b&&(c.dom.innerHTML=b),a}});var d=function(){var a=document.createElement("div");return a.id="gfsdk_root",a.style.position="absolute",a.style.width="100%",a.style.height="100%",a.style.top="0",a.style.left="0",a.style.background="white",a.style.zIndex="1000",document.body.appendChild(a),a},j={logEnabled:!1,httpEnabled:!0,debugMode:!1,startCallback:null,eventCallback:{}},k=function(a,d){var e=b(d),f={canDownload:j.debugMode?"user.candownload":"user.candownload/"+c.contentId,gameover:j.debugMode?"gameover":"gameover/"+c.contentId,userInfo:j.debugMode?"user.lightinfo":"user.lightinfo",updateCredits:j.debugMode?"mipuser.updatecredits":"mipuser.updatecredits",gamifiveInfo:j.debugMode?"GamifiveInfo":null,newChallenge:j.debugMode?"challenge.post":"challenge.post",mipConnect:j.debugMode?"mipuser.fbconnect":"mipuser.fbconnect"};return j.debugMode?g()+"/mock01/"+f[a]:"/v01/"+f[a]+e},l=window.location.search.toLowerCase().indexOf("fbstart"),m=window.location.search.toLowerCase().indexOf("fblogin"),n=function(){var a=window.GamifiveInfo;j.debugMode=f().debug,"undefined"==typeof a&&j.debugMode?h("GET",k("gamifiveInfo"),function(a,b){b.response&&(window.GamifiveInfo=a),n()}):console.warn("No GamifiveInfo found. Set debugMode=TRUE if you are debugging."),"object"==typeof a&&(e(a,c),i.setConfig("appId",c.fbAppId),(l||m)&&i.start(),h("GET",k("userInfo"),function(a,b){b.response&&(c.user=a)})),j.logEnabled&&console.log("GamefiveSDK->init",c)};this.updateConfig=function(a){return"object"!=typeof a&&(a={}),e(a,j),j.logEnabled&&console.log("GamefiveSDK","updateConfig",j),j},this.startSession=function(){function a(){if(j.logEnabled&&console.log("startSession callback now"),c.dom=null,!j.startCallback)throw new Error("No startSession callback found. use GamefiveSDK.onStartSession(callback) to define one before calling the startSession() method");j.startCallback.call()}j.logEnabled&&console.log("GamefiveSDK.startSession",arguments),c.timestart=Date.now(),h("GET",k("canDownload"),function(b,c){j.logEnabled&&console.log("API::canDownload",b.canDownload,c),b.canDownload?a():o("user_no_credits")})},this.onStartSession=function(a){j.logEnabled&&console.log("GamefiveSDK.onStartSession",a),j.startCallback=a},this.onEvent=function(a,b){j.logEnabled&&console.log("GamefiveSDK.onError",b),j.eventCallback[a]=b};var o=function(a){j.eventCallback[a]&&j.eventCallback[a].call()};this.endSession=function(a){j.logEnabled&&console.log("GamefiveSDK.endSession",a),c.timeend=Date.now(),c.score=parseFloat(a.score)||0;var b={start:c.timestart,duration:c.timeend-c.timestart,score:c.score};j.httpEnabled&&h("GET",k("gameover",b),p)};var p=function(a){j.logEnabled&&console.log("render",{da:a}),c.dom=a};this.status=function(){return c};var q=function(){var a={score:c.score,contentId:c.contentId,userId:c.userId};i.invite(a,function(a){if(console.log("FBConnector.invite resp",a),a)if(a.length){var d=b({fbusers_id:a.to||null,userId:c.userId||null});j.httpEnabled&&h("GET",k("updateCredits",d))}else o("fb_invite_empty");else o("fb_invite_error")})};this.invite=function(){!c.requireFbConnect&&c.fbConnected?q():c.requireFbConnect&&!c.fbExternal?FB.login(function(a){"connected"===a.status?h("GET",k("mipConnect",{access_token:a.authResponse.accessToken}),function(a){console.log("mipConnect response",a),200==parseInt(a.status)?q():o("user_fbconnect_fail")}):o("not_authorized"===a.status?"fb_login_noauth":"fb_login_fail"),console.log(a)}):c.requireFbConnect&&c.fbExternal&&(document.location.href=c.fbExternal)},n()}Date.now||(Date.now=function(){return(new Date).getTime()});var e=function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},f=function(){var a=document.querySelector("#gfsdk");if(!a)return{};var b=a.src.replace(/^[^\?]+\??/,""),d=c(b);return d},g=function(){var a=window.location.href.split("/");return a.splice(a.length-1),a.join("/")},h=function(){return function(a,b,c){var d=new XMLHttpRequest;return d.onreadystatechange=function(){if(4===d.readyState){var a;try{a=d.response.replace(/(\r\n|\n|\r)/gm,""),a=JSON.parse(a)}catch(b){}c&&c(a,d)}},d.open(a,b),d.send(),d}}(),i=function(){function a(a){"connected"===a.status?(d(),f.onLogged.call(this,a)):"not_authorized"===a.status?(console.log("Please log into this app."),f.autoLogin&&b()):(console.log("Please auth this app."),f.autoLogin&&b())}function b(){var a=document.body.clientWidth>600?"popup":"touch";FB.login(function(a){a.authResponse?(console.log("Welcome!  Fetching your information.... "),f.onLogged.call(this,a)):(f.onLogged.call(this,a),console.log("User cancelled login or did not fully authorize."))},{scope:"user_friends",display:a})}function c(){!function(a,b,c){var d,e=a.getElementsByTagName(b)[0];a.getElementById(c)||(d=a.createElement(b),d.id=c,d.src="//connect.facebook.net/en_US/sdk.js",e.parentNode.insertBefore(d,e))}(document,"script","facebook-jssdk")}function d(){console.log("Welcome!  Fetching your information.... "),FB.api("/me",function(a){console.log("Successful login for: "+a.name),console.log(a)})}var e=[],f={appId:"",autoLogin:!1,autoStart:!1,onLogged:function(){}},g=function(a){if(e.length>0)return e;var c=0,d=function(d){d&&!d.error?(c++,e=e.concat(d.data),c>1&&a(e)):b(FB.inviteFriends)};FB.api("/me/invitable_friends",d),FB.api("/me/friends",d)};window.fbAsyncInit=function(){FB.init({appId:f.appId,cookie:!0,xfbml:!1,version:"v2.1"}),FB.getLoginStatus(function(b){a(b)})};var h=function(a,b){FB.ui({method:"apprequests",message:"My score is "+a.score+", try to beat me! Play gratis on Gamefive.",data:JSON.stringify(a)},b)};return{start:c,login:b,invite:h,getFriends:g,setConfig:function(a,b){void 0!=f[a]&&(f[a]=b)}}}();a.GamefiveSDK=new d}(window);